#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define MAX_PRODUTOS 100

struct Produto {
    char nome[50];
    float preco;
    int estoque;
};

struct Produto produtos[MAX_PRODUTOS];
int vendasPorProduto[MAX_PRODUTOS] = {0}; // NOVO: Armazena quantidade vendida de cada produto

int totalProdutos = 4;
float saldo = 0.0;
float lucro = 0.0;
int totalVendas = 0;

// Limpa o buffer do teclado
void limparBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

// Lê inteiro com segurança
int lerInt() {
    int num;
    while (scanf("%d", &num) != 1) {
        limparBuffer();
        printf("Digite um número válido: ");
    }
    limparBuffer();
    return num;
}

// Lê float com segurança
float lerFloat() {
    float num;
    while (scanf("%f", &num) != 1) {
        limparBuffer();
        printf("Digite um valor válido: ");
    }
    limparBuffer();
    return num;
}

// Mostrar relatório final com lucro e produtos vendidos
void mostrarRelatorio() {
    printf("\n--- RELATÓRIO FINAL ---\n");
    printf("Total de vendas realizadas: %d\n", totalVendas);
    printf("Lucro total com vendas: R$%.2f\n", lucro);
    printf("\nProdutos vendidos:\n");
    for (int i = 0; i < totalProdutos; i++) {
        if (vendasPorProduto[i] > 0) {
            printf("- %s: %d unidades\n", produtos[i].nome, vendasPorProduto[i]);
        }
    }
}

// Menu de estoque
void menuEstoque() {
    int escolha;
    printf("\n--- ESTOQUE ---\n");
    for (int i = 0; i < totalProdutos; i++) {
        printf("%d - %s | R$%.2f | Estoque: %d\n", i + 1, produtos[i].nome, produtos[i].preco, produtos[i].estoque);
    }
    printf("1. Remover um produto do sistema\n");
    printf("2. Voltar ao menu\n");
    printf("Escolha: ");
    escolha = lerInt();

    if (escolha == 1) {
        printf("Digite o número do produto para remover: ");
        int p = lerInt() - 1;
        if (p >= 0 && p < totalProdutos) {
            for (int i = p; i < totalProdutos - 1; i++) {
                produtos[i] = produtos[i + 1];
                vendasPorProduto[i] = vendasPorProduto[i + 1];
            }
            totalProdutos--;
            printf("Produto removido com sucesso!\n");
        } else {
            printf("Produto inválido!\n");
        }
    }
}

// Menu financeiro
void menuFinanceiro() {
    printf("\n--- FINANCEIRO ---\n");
    printf("Saldo atual: R$%.2f\n", saldo);
    printf("1. Registrar receita\n");
    printf("2. Registrar despesa\n");
    printf("3. Voltar\n");
    printf("Escolha: ");
    int op = lerInt();

    if (op == 1) {
        printf("Valor da receita: R$");
        float valor = lerFloat();
        saldo += valor;
        printf("Receita adicionada!\n");
    } else if (op == 2) {
        printf("Valor da despesa: R$");
        float valor = lerFloat();
        saldo -= valor;
        printf("Despesa registrada!\n");
    }
}

int main() {
    strcpy(produtos[0].nome, "Ben 10");
    produtos[0].preco = 10.0;
    produtos[0].estoque = 50;

    strcpy(produtos[1].nome, "Patati");
    produtos[1].preco = 20.0;
    produtos[1].estoque = 30;

    strcpy(produtos[2].nome, "Kick Buttowski");
    produtos[2].preco = 15.0;
    produtos[2].estoque = 20;

    strcpy(produtos[3].nome, "Eren AOT");
    produtos[3].preco = 25.0;
    produtos[3].estoque = 15;

    int opcao;

    do {
        printf("\n=== MENU PRINCIPAL ===\n");
        printf("1. Ver Estoque\n");
        printf("2. Financeiro\n");
        printf("3. Vender Produto\n");
        printf("4. Adicionar ao Estoque / Novo Produto\n");
        printf("5. Limpar Tela\n");
        printf("6. Sair\n");
        printf("Escolha: ");
        opcao = lerInt();

        if (opcao == 1) {
            menuEstoque();

        } else if (opcao == 2) {
            menuFinanceiro();

        } else if (opcao == 3) {
            printf("\n--- VENDER PRODUTO ---\n");
            for (int i = 0; i < totalProdutos; i++) {
                printf("%d - %s | R$%.2f | Estoque: %d\n", i + 1, produtos[i].nome, produtos[i].preco, produtos[i].estoque);
            }
            printf("Escolha o produto: ");
            int p = lerInt() - 1;
            if (p < 0 || p >= totalProdutos) {
                printf("Produto inválido!\n");
            } else {
                printf("Quantidade: ");
                int q = lerInt();
                if (q > produtos[p].estoque) {
                    printf("Estoque insuficiente!\n");
                } else {
                    printf("Forma de pagamento:\n");
                    printf("1. Dinheiro (10%% de desconto)\n");
                    printf("2. Cartão (sem desconto)\n");
                    printf("Escolha: ");
                    int forma = lerInt();

                    float total = q * produtos[p].preco;

                    if (forma == 1) {
                        total *= 0.9; // 10% de desconto
                    }

                    produtos[p].estoque -= q;
                    saldo += total;
                    lucro += total;
                    totalVendas++;
                    vendasPorProduto[p] += q;

                    printf("Venda feita! Total: R$%.2f\n", total);
                }
            }

        } else if (opcao == 4) {
            printf("\n--- ADICIONAR ESTOQUE OU PRODUTO ---\n");
            printf("Nome do produto: ");
            char nome[50];
            fgets(nome, sizeof(nome), stdin);
            nome[strcspn(nome, "\n")] = '\0';

            int index = -1;
            for (int i = 0; i < totalProdutos; i++) {
                if (strcmp(produtos[i].nome, nome) == 0) {
                    index = i;
                    break;
                }
            }

            printf("Preço: R$");
            float preco = lerFloat();
            printf("Quantidade: ");
            int q = lerInt();

            float custo = preco * q;
            if (saldo >= custo) {
                if (index != -1) {
                    produtos[index].estoque += q;
                    saldo -= custo;
                    printf("Estoque adicionado ao produto existente.\n");
                } else {
                    if (totalProdutos < MAX_PRODUTOS) {
                        strcpy(produtos[totalProdutos].nome, nome);
                        produtos[totalProdutos].preco = preco;
                        produtos[totalProdutos].estoque = q;
                        totalProdutos++;
                        saldo -= custo;
                        printf("Novo produto adicionado com sucesso.\n");
                    } else {
                        printf("Limite de produtos atingido!\n");
                    }
                }
            } else {
                printf("Saldo insuficiente para essa operação!\n");
            }

        } else if (opcao == 5) {
            #ifdef _WIN32
                system("cls");
            #else
                system("clear");
            #endif
            printf("Tela limpa!\n");

        } else if (opcao == 6) {
            mostrarRelatorio();
            printf("Saindo...\n");

        } else {
            printf("Opção inválida!\n");
        }

    } while (opcao != 6);

    return 0;
}

